<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Trip Generation | Urban Transportation Planning</title>
  <meta name="description" content="These are notes and assignments related to the Urban Transportation Planning class at BYU." />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Trip Generation | Urban Transportation Planning" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="These are notes and assignments related to the Urban Transportation Planning class at BYU." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Trip Generation | Urban Transportation Planning" />
  
  <meta name="twitter:description" content="These are notes and assignments related to the Urban Transportation Planning class at BYU." />
  

<meta name="author" content="Gregory Macfarlane, PhD, PE" />


<meta name="date" content="2020-08-12" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="chap-blocks.html"/>
<link rel="next" href="chap-distribution.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Urban Transportation Planning</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Foreword</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="chap-blocks.html"><a href="chap-blocks.html"><i class="fa fa-check"></i><b>1</b> Building Blocks</a><ul>
<li class="chapter" data-level="1.1" data-path="chap-blocks.html"><a href="chap-blocks.html#planning-for-human-systems"><i class="fa fa-check"></i><b>1.1</b> Planning for Human Systems</a></li>
<li class="chapter" data-level="1.2" data-path="chap-blocks.html"><a href="chap-blocks.html#the-four-step-process"><i class="fa fa-check"></i><b>1.2</b> The Four-Step Process</a></li>
<li class="chapter" data-level="1.3" data-path="chap-blocks.html"><a href="chap-blocks.html#travel-model-building-blocks"><i class="fa fa-check"></i><b>1.3</b> Travel Model Building Blocks</a><ul>
<li class="chapter" data-level="1.3.1" data-path="chap-blocks.html"><a href="chap-blocks.html#household-travel-surveys"><i class="fa fa-check"></i><b>1.3.1</b> Household Travel Surveys</a></li>
<li class="chapter" data-level="1.3.2" data-path="chap-blocks.html"><a href="chap-blocks.html#travel-analysis-zones"><i class="fa fa-check"></i><b>1.3.2</b> Travel Analysis Zones</a></li>
<li class="chapter" data-level="1.3.3" data-path="chap-blocks.html"><a href="chap-blocks.html#highway-networks"><i class="fa fa-check"></i><b>1.3.3</b> Highway Networks</a></li>
<li class="chapter" data-level="1.3.4" data-path="chap-blocks.html"><a href="chap-blocks.html#matrices"><i class="fa fa-check"></i><b>1.3.4</b> Matrices</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="chap-blocks.html"><a href="chap-blocks.html#statistical-and-mathematical-techniques"><i class="fa fa-check"></i><b>1.4</b> Statistical and Mathematical Techniques</a><ul>
<li class="chapter" data-level="1.4.1" data-path="chap-blocks.html"><a href="chap-blocks.html#continuous-and-discrete-distributions"><i class="fa fa-check"></i><b>1.4.1</b> Continuous and Discrete Distributions</a></li>
<li class="chapter" data-level="1.4.2" data-path="chap-blocks.html"><a href="chap-blocks.html#iterative-proportional-fitting"><i class="fa fa-check"></i><b>1.4.2</b> Iterative Proportional Fitting</a></li>
<li class="chapter" data-level="1.4.3" data-path="chap-blocks.html"><a href="chap-blocks.html#regression-analysis"><i class="fa fa-check"></i><b>1.4.3</b> Regression Analysis</a></li>
<li class="chapter" data-level="1.4.4" data-path="chap-blocks.html"><a href="chap-blocks.html#numerical-optimization"><i class="fa fa-check"></i><b>1.4.4</b> Numerical Optimization</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="chap-blocks.html"><a href="chap-blocks.html#hw-blocks"><i class="fa fa-check"></i>Homework</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="chap-tripgen.html"><a href="chap-tripgen.html"><i class="fa fa-check"></i><b>2</b> Trip Generation</a><ul>
<li class="chapter" data-level="2.1" data-path="chap-tripgen.html"><a href="chap-tripgen.html#trip-production"><i class="fa fa-check"></i><b>2.1</b> Trip Production</a></li>
<li class="chapter" data-level="2.2" data-path="chap-tripgen.html"><a href="chap-tripgen.html#trip-attraction"><i class="fa fa-check"></i><b>2.2</b> Trip Attraction</a></li>
<li class="chapter" data-level="2.3" data-path="chap-tripgen.html"><a href="chap-tripgen.html#homework"><i class="fa fa-check"></i><b>2.3</b> Homework</a></li>
<li class="chapter" data-level="2.4" data-path="chap-tripgen.html"><a href="chap-tripgen.html#lab"><i class="fa fa-check"></i><b>2.4</b> Lab</a><ul>
<li class="chapter" data-level="2.4.1" data-path="chap-tripgen.html"><a href="chap-tripgen.html#trip-production-1"><i class="fa fa-check"></i><b>2.4.1</b> Trip Production</a></li>
<li class="chapter" data-level="2.4.2" data-path="chap-tripgen.html"><a href="chap-tripgen.html#trip-attraction-1"><i class="fa fa-check"></i><b>2.4.2</b> Trip Attraction</a></li>
<li class="chapter" data-level="2.4.3" data-path="chap-tripgen.html"><a href="chap-tripgen.html#report"><i class="fa fa-check"></i><b>2.4.3</b> Report</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="chap-distribution.html"><a href="chap-distribution.html"><i class="fa fa-check"></i><b>3</b> Trip Distribution</a></li>
<li class="chapter" data-level="4" data-path="chap-modechoice.html"><a href="chap-modechoice.html"><i class="fa fa-check"></i><b>4</b> Mode and Destination Choice</a><ul>
<li class="chapter" data-level="" data-path="chap-modechoice.html"><a href="chap-modechoice.html#hw-modechoice"><i class="fa fa-check"></i>Homework</a></li>
<li class="chapter" data-level="4.1" data-path="chap-modechoice.html"><a href="chap-modechoice.html#lab-1"><i class="fa fa-check"></i><b>4.1</b> Lab</a><ul>
<li class="chapter" data-level="4.1.1" data-path="chap-modechoice.html"><a href="chap-modechoice.html#mode-choice-calibration"><i class="fa fa-check"></i><b>4.1.1</b> Mode Choice Calibration</a></li>
<li class="chapter" data-level="4.1.2" data-path="chap-modechoice.html"><a href="chap-modechoice.html#destination-choice-calibration"><i class="fa fa-check"></i><b>4.1.2</b> Destination Choice Calibration</a></li>
<li class="chapter" data-level="4.1.3" data-path="chap-modechoice.html"><a href="chap-modechoice.html#report-1"><i class="fa fa-check"></i><b>4.1.3</b> Report</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="chap-assignment.html"><a href="chap-assignment.html"><i class="fa fa-check"></i><b>5</b> Network Assignment and Validation</a></li>
<li class="chapter" data-level="6" data-path="chap-process.html"><a href="chap-process.html"><i class="fa fa-check"></i><b>6</b> The Planning Process</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="app-demomodel.html"><a href="app-demomodel.html"><i class="fa fa-check"></i><b>A</b> Demonstration Model</a><ul>
<li class="chapter" data-level="A.1" data-path="app-demomodel.html"><a href="app-demomodel.html#running-the-model"><i class="fa fa-check"></i><b>A.1</b> Running the Model</a></li>
<li class="chapter" data-level="A.2" data-path="app-demomodel.html"><a href="app-demomodel.html#files-and-reports"><i class="fa fa-check"></i><b>A.2</b> Files and Reports</a></li>
<li class="chapter" data-level="A.3" data-path="app-demomodel.html"><a href="app-demomodel.html#cube-tips-and-tricks"><i class="fa fa-check"></i><b>A.3</b> Cube Tips and Tricks</a><ul>
<li class="chapter" data-level="A.3.1" data-path="app-demomodel.html"><a href="app-demomodel.html#shortest-paths"><i class="fa fa-check"></i><b>A.3.1</b> Shortest Paths</a></li>
<li class="chapter" data-level="A.3.2" data-path="app-demomodel.html"><a href="app-demomodel.html#working-with-matrices"><i class="fa fa-check"></i><b>A.3.2</b> Working with Matrices</a></li>
<li class="chapter" data-level="A.3.3" data-path="app-demomodel.html"><a href="app-demomodel.html#writing-custom-scripts"><i class="fa fa-check"></i><b>A.3.3</b> Writing Custom Scripts</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="app-rstudio.html"><a href="app-rstudio.html"><i class="fa fa-check"></i><b>B</b> R and RStudio Help</a><ul>
<li class="chapter" data-level="B.1" data-path="app-rstudio.html"><a href="app-rstudio.html#installing"><i class="fa fa-check"></i><b>B.1</b> Installing</a></li>
<li class="chapter" data-level="B.2" data-path="app-rstudio.html"><a href="app-rstudio.html#rstudio-orientation"><i class="fa fa-check"></i><b>B.2</b> RStudio Orientation</a></li>
<li class="chapter" data-level="B.3" data-path="app-rstudio.html"><a href="app-rstudio.html#r-packages"><i class="fa fa-check"></i><b>B.3</b> R Packages</a></li>
<li class="chapter" data-level="B.4" data-path="app-rstudio.html"><a href="app-rstudio.html#working-with-tables"><i class="fa fa-check"></i><b>B.4</b> Working with Tables</a><ul>
<li class="chapter" data-level="B.4.1" data-path="app-rstudio.html"><a href="app-rstudio.html#reading-data"><i class="fa fa-check"></i><b>B.4.1</b> Reading Data</a></li>
<li class="chapter" data-level="B.4.2" data-path="app-rstudio.html"><a href="app-rstudio.html#modifying-and-summarizing-tables"><i class="fa fa-check"></i><b>B.4.2</b> Modifying and Summarizing Tables</a></li>
<li class="chapter" data-level="B.4.3" data-path="app-rstudio.html"><a href="app-rstudio.html#app-mutate"><i class="fa fa-check"></i><b>B.4.3</b> Mutate, Summarize, and Group</a></li>
</ul></li>
<li class="chapter" data-level="B.5" data-path="app-rstudio.html"><a href="app-rstudio.html#graphics-with-ggplot2"><i class="fa fa-check"></i><b>B.5</b> Graphics with <code>ggplot2</code></a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Urban Transportation Planning</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="chap-tripgen" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Trip Generation</h1>
<p>The details of the Trip Generation models are given in section 4.4 of <em>NCHRP 716</em>
and in the course notes. In this unit we will use data from both the NHTS
and from the Puget Sound Regional Council (PSRC).</p>
<div id="trip-production" class="section level2">
<h2><span class="header-section-number">2.1</span> Trip Production</h2>
<p>The trip production model is a cross-classification model. What this means
is that we will classify households into different bins based on their
household size, income, vehicle ownership, etc. We will then calculate the
average number of trips made by households in each group.</p>
<p>We will need to get the data for households and trips. Use the records for
households in MSA size <code>02</code>, that completed the survey on a weekday, and then
filter the trips to include only those records. We can also select only the data
columns that have the information we will use to classify the model. We might
need to create some or modify variables that we need to use to cross-classify;
for instance we should cap the household size category at 4 people and the
vehicles at 3.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="chap-tripgen.html#cb18-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb18-2"><a href="chap-tripgen.html#cb18-2"></a><span class="kw">library</span>(nhts2017)</span>
<span id="cb18-3"><a href="chap-tripgen.html#cb18-3"></a></span>
<span id="cb18-4"><a href="chap-tripgen.html#cb18-4"></a>hh &lt;-<span class="st"> </span>nhts_households <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-5"><a href="chap-tripgen.html#cb18-5"></a><span class="st">  </span><span class="co"># filter to MSA size 2, travel on weekday</span></span>
<span id="cb18-6"><a href="chap-tripgen.html#cb18-6"></a><span class="st">  </span><span class="kw">filter</span>(msasize <span class="op">==</span><span class="st"> &quot;02&quot;</span>, <span class="op">!</span>travday <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;01&quot;</span>, <span class="st">&quot;07&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb18-7"><a href="chap-tripgen.html#cb18-7"></a><span class="st">  </span><span class="co"># select the columns we care about.</span></span>
<span id="cb18-8"><a href="chap-tripgen.html#cb18-8"></a><span class="st">  </span><span class="kw">select</span>(houseid, wthhfin, hhsize, hhvehcnt, numadlt, hhfaminc, wrkcount) <span class="op">%&gt;%</span></span>
<span id="cb18-9"><a href="chap-tripgen.html#cb18-9"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb18-10"><a href="chap-tripgen.html#cb18-10"></a>    <span class="dt">hhsize =</span> <span class="kw">ifelse</span>(hhsize <span class="op">&gt;</span><span class="st"> </span><span class="dv">4</span>, <span class="dv">4</span>, hhsize),</span>
<span id="cb18-11"><a href="chap-tripgen.html#cb18-11"></a>    <span class="dt">hhvehcnt =</span> <span class="kw">ifelse</span>(hhvehcnt <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>, <span class="dv">3</span>, hhvehcnt)</span>
<span id="cb18-12"><a href="chap-tripgen.html#cb18-12"></a>  )</span>
<span id="cb18-13"><a href="chap-tripgen.html#cb18-13"></a>hh</span></code></pre></div>
<pre><code>## # A tibble: 10,381 x 7
##    houseid  wthhfin hhsize hhvehcnt numadlt hhfaminc                  wrkcount
##    &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr+lbl&gt;                    &lt;dbl&gt;
##  1 30000019   279.       2        2       2 03 [$15,000 to $24,999]          0
##  2 30000288   103.       1        2       1 05 [$35,000 to $49,999]          0
##  3 30000289   244.       3        3       2 07 [$75,000 to $99,999]          1
##  4 30000463   348.       2        2       2 06 [$50,000 to $74,999]          2
##  5 30000465   133.       4        2       2 08 [$100,000 to $124,999]        2
##  6 30000478   120.       2        0       2 03 [$15,000 to $24,999]          0
##  7 30000545    35.7      2        3       2 06 [$50,000 to $74,999]          2
##  8 30000770   130.       1        1       1 06 [$50,000 to $74,999]          1
##  9 30000983   147.       4        3       4 09 [$125,000 to $149,999]        1
## 10 30001177   304.       2        0       2 04 [$25,000 to $34,999]          2
## # … with 10,371 more rows</code></pre>
<p>The next step is we need to calculate how many trips the members of each
household in the data took. To do this, we can use <code>summarise</code> to count the number of
trip rows for each household. Then, we can <code>pivot_wider</code> to spread the trips
out by purpose.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="chap-tripgen.html#cb20-1"></a>trips &lt;-<span class="st"> </span>nhts_trips <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-2"><a href="chap-tripgen.html#cb20-2"></a><span class="st">  </span><span class="co"># filter to households in the data</span></span>
<span id="cb20-3"><a href="chap-tripgen.html#cb20-3"></a><span class="st">  </span><span class="kw">filter</span>(houseid <span class="op">%in%</span><span class="st"> </span>hh<span class="op">$</span>houseid) <span class="op">%&gt;%</span></span>
<span id="cb20-4"><a href="chap-tripgen.html#cb20-4"></a><span class="st">  </span><span class="kw">group_by</span>(houseid, trippurp) <span class="op">%&gt;%</span></span>
<span id="cb20-5"><a href="chap-tripgen.html#cb20-5"></a><span class="st">  </span><span class="co"># count up how many trips each household took</span></span>
<span id="cb20-6"><a href="chap-tripgen.html#cb20-6"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">trips =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb20-7"><a href="chap-tripgen.html#cb20-7"></a><span class="st">  </span><span class="co"># &quot;spread&quot; the data, filling zero if no trips were taken</span></span>
<span id="cb20-8"><a href="chap-tripgen.html#cb20-8"></a><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">id_cols =</span> houseid, <span class="dt">names_from =</span> trippurp, </span>
<span id="cb20-9"><a href="chap-tripgen.html#cb20-9"></a>              <span class="dt">values_from =</span> trips, <span class="dt">values_fill =</span> <span class="dv">0</span>)</span></code></pre></div>
<pre><code>## `summarise()` regrouping output by &#39;houseid&#39; (override with `.groups` argument)</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="chap-tripgen.html#cb22-1"></a>trips</span></code></pre></div>
<pre><code>## # A tibble: 9,518 x 7
## # Groups:   houseid [9,518]
##    houseid    HBO HBSHOP   NHB HBSOCREC   HBW  `-9`
##    &lt;chr&gt;    &lt;int&gt;  &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1 30000019     4      0     0        0     0     0
##  2 30000288     1      1     4        0     0     0
##  3 30000289     2      4     3        1     1     0
##  4 30000463     7      2     6        0     0     0
##  5 30000465     8      2     9        0     1     0
##  6 30000478     2      0     0        0     0     0
##  7 30000545     0      2     2        4     2     0
##  8 30000770     0      3     1        0     1     0
##  9 30000983     4      0     2        1     2     0
## 10 30001177     3      2     0        2     2     0
## # … with 9,508 more rows</code></pre>
<p>Now, we will <code>join</code> the trips data frame to the households data frame so that
everything is in one place. Note that when we do this, there will be some households
that never made any trips; we need to change their trip counts from <code>NA</code> to <code>0</code>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="chap-tripgen.html#cb24-1"></a><span class="co"># function to change NA to 0</span></span>
<span id="cb24-2"><a href="chap-tripgen.html#cb24-2"></a>nato0 &lt;-<span class="st"> </span><span class="cf">function</span>(x) {<span class="kw">ifelse</span>(<span class="kw">is.na</span>(x), <span class="dv">0</span>, x)}</span>
<span id="cb24-3"><a href="chap-tripgen.html#cb24-3"></a></span>
<span id="cb24-4"><a href="chap-tripgen.html#cb24-4"></a>tripprod &lt;-<span class="st"> </span>hh <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb24-5"><a href="chap-tripgen.html#cb24-5"></a><span class="st">  </span><span class="co"># join tables by id field</span></span>
<span id="cb24-6"><a href="chap-tripgen.html#cb24-6"></a><span class="st">  </span><span class="kw">left_join</span>(trips, <span class="dt">by =</span> <span class="st">&quot;houseid&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb24-7"><a href="chap-tripgen.html#cb24-7"></a><span class="st">  </span><span class="co"># change all NA values in columns from the trips data to 0.a</span></span>
<span id="cb24-8"><a href="chap-tripgen.html#cb24-8"></a><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">names</span>(trips)), nato0)</span>
<span id="cb24-9"><a href="chap-tripgen.html#cb24-9"></a>tripprod</span></code></pre></div>
<pre><code>## # A tibble: 10,381 x 13
##    houseid wthhfin hhsize hhvehcnt numadlt hhfaminc wrkcount   HBO HBSHOP   NHB
##    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr+lb&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1 300000…   279.       2        2       2 03 [$15…        0     4      0     0
##  2 300002…   103.       1        2       1 05 [$35…        0     1      1     4
##  3 300002…   244.       3        3       2 07 [$75…        1     2      4     3
##  4 300004…   348.       2        2       2 06 [$50…        2     7      2     6
##  5 300004…   133.       4        2       2 08 [$10…        2     8      2     9
##  6 300004…   120.       2        0       2 03 [$15…        0     2      0     0
##  7 300005…    35.7      2        3       2 06 [$50…        2     0      2     2
##  8 300007…   130.       1        1       1 06 [$50…        1     0      3     1
##  9 300009…   147.       4        3       4 09 [$12…        1     4      0     2
## 10 300011…   304.       2        0       2 04 [$25…        2     3      2     0
## # … with 10,371 more rows, and 3 more variables: HBSOCREC &lt;dbl&gt;, HBW &lt;dbl&gt;,
## #   `-9` &lt;dbl&gt;</code></pre>
<p>Now we can count up the number of trips by grouping the variables we care
about and taking the average. For instance, we can get the average HBO trip rate
for households by size and vehicle count. Remember to weight!</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="chap-tripgen.html#cb26-1"></a>hbo_tripprod &lt;-<span class="st"> </span>tripprod <span class="op">%&gt;%</span></span>
<span id="cb26-2"><a href="chap-tripgen.html#cb26-2"></a><span class="st">  </span><span class="kw">group_by</span>(hhsize, hhvehcnt) <span class="op">%&gt;%</span></span>
<span id="cb26-3"><a href="chap-tripgen.html#cb26-3"></a><span class="st">  </span><span class="kw">summarise</span>(</span>
<span id="cb26-4"><a href="chap-tripgen.html#cb26-4"></a>    <span class="dt">n =</span> <span class="kw">n</span>(), <span class="co"># number of households in category</span></span>
<span id="cb26-5"><a href="chap-tripgen.html#cb26-5"></a>    <span class="dt">HBO =</span> <span class="kw">weighted.mean</span>(HBO, wthhfin), <span class="co"># average HBO trips per hh</span></span>
<span id="cb26-6"><a href="chap-tripgen.html#cb26-6"></a>  )</span></code></pre></div>
<pre><code>## `summarise()` regrouping output by &#39;hhsize&#39; (override with `.groups` argument)</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="chap-tripgen.html#cb28-1"></a>hbo_tripprod</span></code></pre></div>
<pre><code>## # A tibble: 16 x 4
## # Groups:   hhsize [4]
##    hhsize hhvehcnt     n   HBO
##     &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;
##  1      1        0   345 0.414
##  2      1        1  2263 0.558
##  3      1        2   541 0.540
##  4      1        3   207 0.339
##  5      2        0    55 0.420
##  6      2        1   782 1.55 
##  7      2        2  2472 1.15 
##  8      2        3  1282 1.12 
##  9      3        0    25 3.98 
## 10      3        1   161 1.90 
## 11      3        2   422 2.04 
## 12      3        3   561 1.93 
## 13      4        0    12 3.32 
## 14      4        1   120 5.28 
## 15      4        2   556 4.31 
## 16      4        3   577 4.19</code></pre>
</div>
<div id="trip-attraction" class="section level2">
<h2><span class="header-section-number">2.2</span> Trip Attraction</h2>
<p>Trip attraction models estimate how many trips will be attracted to a particular
zone. This is a function of how many jobs of different kinds are in a zone, in
addition to other elements of a zone. Trip attraction models are often a linear
regression model.</p>
<p>The NHTS cannot be used to estimate trip attraction models because we do not
know how many trips went to each TAZ; we only see the household side of the
survey. So we will use a file that I have prepared from the Puget Sound Regional
Council (PSRC, Seattle) household travel survey. This file is available <a href="https://byu.box.com/shared/static/7ci8vomip719bdno7xl5ftjj940dausm.csv">on Box</a>. You
can download it and read it directly into an R session with the <code>read_csv()</code> function,</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="chap-tripgen.html#cb30-1"></a>psrc_attractions &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;https://byu.box.com/shared/static/7ci8vomip719bdno7xl5ftjj940dausm.csv&quot;</span>)</span></code></pre></div>
<pre><code>## Parsed with column specification:
## cols(
##   attr_tract = col_double(),
##   HBO = col_double(),
##   HBShop = col_double(),
##   HBW = col_double(),
##   NHB = col_double(),
##   tothh = col_double(),
##   retl = col_double(),
##   manu = col_double(),
##   offi = col_double(),
##   gved = col_double(),
##   othr = col_double(),
##   totemp = col_double()
## )</code></pre>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="chap-tripgen.html#cb32-1"></a>psrc_attractions</span></code></pre></div>
<pre><code>## # A tibble: 643 x 12
##    attr_tract    HBO HBShop    HBW    NHB tothh  retl  manu  offi  gved  othr
##         &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1    5.30e10 8.92e3 1.02e3 6151.  4.70e2  3779   508   121   680    28   199
##  2    5.30e10 2.58e4 1.48e2    0   1.03e4  3654   146     0   605   264   117
##  3    5.30e10 3.90e1 1.30e1    0   8.50e2  1187    50     0   574     0     0
##  4    5.30e10 1.22e3 4.78e2   83.1 2.79e3  3760   385     0   773   211    99
##  5    5.30e10 5.08e3 3.53e2    0   5.30e3  2437    97    53   981    27   124
##  6    5.30e10 0.     0.        0   9.89e1  1251     0     0    96     2    93
##  7    5.30e10 9.79e3 4.22e3 1937.  3.22e4  3413   997     0  4017   527   101
##  8    5.30e10 5.66e3 3.24e1  178.  4.20e3  2222   315     0   967    19    89
##  9    5.30e10 1.65e3 1.08e0    0   2.22e3  1067     0     0    33    61    15
## 10    5.30e10 2.07e3 0.        0   4.25e0   868     0     0    80     0     5
## # … with 633 more rows, and 1 more variable: totemp &lt;dbl&gt;</code></pre>
<p>This file has, for every tract in the Seattle metro region, how many trips were
attracted to the tract by purpose as well as the households and jobs by type in
that tract. Let’s look at the relationship between HBW trips and total
employment:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="chap-tripgen.html#cb34-1"></a><span class="kw">ggplot</span>(psrc_attractions, <span class="kw">aes</span>(<span class="dt">x =</span> totemp, <span class="dt">y =</span> HBW)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb34-2"><a href="chap-tripgen.html#cb34-2"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">stat_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula &#39;y ~ x&#39;</code></pre>
<pre><code>## Warning: Removed 1 rows containing non-finite values (stat_smooth).</code></pre>
<pre><code>## Warning: Removed 1 rows containing missing values (geom_point).</code></pre>
<p><img src="02_tripgen_files/figure-html/totemp-hbw-1.png" width="672" /></p>
<p>We can estimate a linear regression model with the <code>lm</code> function. In this function
we specify the model as <code>y ~ x + ...</code>.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="chap-tripgen.html#cb38-1"></a>lm_hbw_totemp &lt;-<span class="st"> </span><span class="kw">lm</span>(HBW <span class="op">~</span><span class="st"> </span>totemp, <span class="dt">data =</span> psrc_attractions)</span>
<span id="cb38-2"><a href="chap-tripgen.html#cb38-2"></a><span class="kw">summary</span>(lm_hbw_totemp)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = HBW ~ totemp, data = psrc_attractions)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -41447  -1955  -1180   -699  56593 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 530.34960  300.96059   1.762   0.0785 .  
## totemp        0.98197    0.04386  22.388   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 6902 on 640 degrees of freedom
##   (1 observation deleted due to missingness)
## Multiple R-squared:  0.4392, Adjusted R-squared:  0.4383 
## F-statistic: 501.2 on 1 and 640 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Let’s estimate a more complex for HBO trips with many predictors.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="chap-tripgen.html#cb40-1"></a>hbo_rates &lt;-<span class="st"> </span><span class="kw">lm</span>(HBO <span class="op">~</span><span class="st"> </span>tothh <span class="op">+</span><span class="st"> </span>retl <span class="op">+</span><span class="st"> </span>manu <span class="op">+</span><span class="st"> </span>offi <span class="op">+</span><span class="st"> </span>gved <span class="op">+</span><span class="st"> </span>othr, </span>
<span id="cb40-2"><a href="chap-tripgen.html#cb40-2"></a>                <span class="dt">data =</span> psrc_attractions)</span>
<span id="cb40-3"><a href="chap-tripgen.html#cb40-3"></a><span class="kw">summary</span>(hbo_rates)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = HBO ~ tothh + retl + manu + offi + gved + othr, 
##     data = psrc_attractions)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -24039  -6216  -4083   -818 227788 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)   
## (Intercept) -394.4522  2045.5441  -0.193  0.84715   
## tothh          3.0939     0.9421   3.284  0.00108 **
## retl           2.8846     1.4143   2.040  0.04180 * 
## manu           1.3558     1.5214   0.891  0.37320   
## offi           0.3982     0.2207   1.804  0.07165 . 
## gved           0.5974     0.4671   1.279  0.20137   
## othr           0.0726     0.9776   0.074  0.94082   
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 17030 on 635 degrees of freedom
##   (1 observation deleted due to missingness)
## Multiple R-squared:  0.07254,    Adjusted R-squared:  0.06378 
## F-statistic: 8.278 on 6 and 635 DF,  p-value: 1.199e-08</code></pre>
<p>The <span class="math inline">\(R^2\)</span> statistic is not particularly good, but it really never will be with
this kind of data. More important is the relationship with the residuals. It’s
also not very good; there are a few outliers and quite a bit of
heteroskedasticity. But there may be things we can try to make it better.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="chap-tripgen.html#cb42-1"></a><span class="kw">plot</span>(hbo_rates, <span class="dt">which =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="02_tripgen_files/figure-html/fitted-1.png" width="672" /></p>
</div>
<div id="homework" class="section level2">
<h2><span class="header-section-number">2.3</span> Homework</h2>
<ol style="list-style-type: decimal">
<li><p>Calculate the trip rates for each purpose by household size, and by income
group. Do the rates make sense? Why or why not?</p></li>
<li><p>Calculate the trip rates for each purpose by the number of household workers
and the vehicle availability. Do the rates make sense? Why or why not?</p></li>
<li><p>Calculate the <em>variance</em> or <em>standard deviation</em> in work trip rates by
household size / vehicles and by number of workers / vehicles. Which
classification should be used for work trips?</p></li>
<li><p>Calculate the number of households in each classification (size /
vehicles), (workers / vehicles). What information does this give you about the
estimated trip rates?</p></li>
<li><p>Estimate trip rate attraction models for all the trip purposes.
Present models with only significant or influential factors (try a few different
specifications until you are satisfied with your models’ performance)</p></li>
<li><p>Explain your attraction rate models; do the rates make sense? Which
models have the best fit in terms of <span class="math inline">\(R^2\)</span> value? Why?</p></li>
<li><p>Remove the intercept from your model estimations. In R, you can do
this by adding a <code>-1</code> to the formula, as in <code>lm(y ~ x - 1)</code>. Do the rates
change? By how much? Should you keep the intercept in or remove it?</p></li>
</ol>
</div>
<div id="lab" class="section level2">
<h2><span class="header-section-number">2.4</span> Lab</h2>
<p>In this lab you will implement and calibrate trip generation rates for the RVTPO
model.</p>
<div id="trip-production-1" class="section level3">
<h3><span class="header-section-number">2.4.1</span> Trip Production</h3>
<p>The trip production rates are stored in the <code>params/trip_prod/</code> folder, with a
dbf file for each trip purpose in the model. We are going to calibrate the
following trip purposes:</p>
<ul>
<li><code>HBW</code>: cross-classification model of workers and vehicles available</li>
<li><code>HBO</code>: cross-classification model of household persons and vehicles available</li>
<li><code>HBShop</code>: cross-classification model of household persons and vehicles available</li>
</ul>
<p>The household travel survey for the RVTPO region reported the following total
weighted trips in these trip purposes:</p>
<table>
<thead>
<tr class="header">
<th align="left">Purpose</th>
<th align="right">Weighted Survey Trips</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HBW</td>
<td align="right">118,653</td>
</tr>
<tr class="even">
<td align="left">HBO</td>
<td align="right">267,987</td>
</tr>
<tr class="odd">
<td align="left">HBShop</td>
<td align="right">129,614</td>
</tr>
</tbody>
</table>
<p>Begin by running the RVTPO model through the Trip Generation
submodel. The trip productions for each trip purpose are recorded in
<code>Base/outputs/HH_PROD.dbf</code>. Using this file, create a report that sums the trips
produced in each of these three purposes. You can read this file in R using
the <code>read.dbf()</code> function in the <code>foreign</code> library, and then sum all columns in
this table using the <code>summarize_all</code> function.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="chap-tripgen.html#cb43-1"></a><span class="co"># read roanoke household trip productions</span></span>
<span id="cb43-2"><a href="chap-tripgen.html#cb43-2"></a>rvtpo_productions &lt;-<span class="st"> </span>foreign<span class="op">::</span><span class="kw">read.dbf</span>(<span class="st">&quot;data/HH_PROD.DBF&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb43-3"><a href="chap-tripgen.html#cb43-3"></a><span class="st">  </span><span class="kw">as_tibble</span>()</span>
<span id="cb43-4"><a href="chap-tripgen.html#cb43-4"></a><span class="co"># show first 10 rows</span></span>
<span id="cb43-5"><a href="chap-tripgen.html#cb43-5"></a>rvtpo_productions</span></code></pre></div>
<pre><code>## # A tibble: 267 x 7
##      TAZ  HBWP NHBWP  HBOP HBSCP HBSHP NHBOP
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1     1 199.  113.  199.  112.  199.  384. 
##  2     2  38.6  22.0  38.6  21.8  38.6  74.5
##  3     3  88    50.2  88    49.7  88   170. 
##  4     4 265.  151.  265.  150.  265.  512. 
##  5     5 116.   65.9 116.   65.3 116.  223. 
##  6     6  69.0  39.4  69.0  39.0  69.0 133. 
##  7     7  26.7  15.2  26.7  15.1  26.7  51.7
##  8     8 174.   99.2 174.   98.2 174.  336. 
##  9     9  82.2  46.9  82.2  46.5  82.2 159. 
## 10    10 177.  101.  177.  100.  177.  343. 
## # … with 257 more rows</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="chap-tripgen.html#cb45-1"></a>rvtpo_productions <span class="op">%&gt;%</span></span>
<span id="cb45-2"><a href="chap-tripgen.html#cb45-2"></a><span class="st">  </span><span class="kw">summarize_all</span>( sum )</span></code></pre></div>
<pre><code>## # A tibble: 1 x 7
##     TAZ   HBWP  NHBWP   HBOP  HBSCP  HBSHP  NHBOP
##   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 35778 28200. 16093. 28200. 15933. 28200. 54513.</code></pre>
<p>Obviously the bare model is not very close to the targets. Replace the bare
model rates with rates you estimated from the NHTS during your homework
assignment. Run your tabulation report again, and compare the total productions
to the regional targets.</p>
<p>Adjust the trip rates so that they replicate the regional survey targets within
an acceptable margin of error. Ensure that the comparative relationship between
the trip rates is maintained (i.e. households with more workers must make at
least as many work trips).</p>
</div>
<div id="trip-attraction-1" class="section level3">
<h3><span class="header-section-number">2.4.2</span> Trip Attraction</h3>
<p>The trip attraction rates enter into the destination choice model, but it is
helpful to compare the total forecasted attractions using the rates you
estimated. Apply the rates to the zonal socioeconomic data file and calculate
the total number of attracted trips for each of the three purposes. Adjust the
rates so that the total attractions for your three estimated purposes match the
regional totals.</p>
</div>
<div id="report" class="section level3">
<h3><span class="header-section-number">2.4.3</span> Report</h3>
<p>Prepare a technical report describing the process by which you estimated
household trip production and attraction rates, and calibrated the trip rates to
reproduce regional totals. Calculate the margin of error for <em>all</em> purposes (not
just the purposes you calibrated). Discuss how well the calibrated trip
generation models replicates the survey targets, and justify your residual
error. Use formatted tables to display results instead of screenshots of output.</p>
<p>You will be graded on the overall readability, flow, formatting and grammar in
addition to how clearly you articulate the process of your work.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="chap-blocks.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="chap-distribution.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["ceen565.pdf", "ceen565.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
